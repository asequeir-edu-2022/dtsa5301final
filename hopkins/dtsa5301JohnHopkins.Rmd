---
title: "COVID19 Data from John Hopkins"
author: "Antony Sequeira"
date: "2/9/2022"
output: pdf_document
---

# Following script installs the required libraries in Mac OSX
This section can be copied to a file or input into R console.  
You could also download it from my repo at https://github.com/asequeir-edu-2022/dtsa5301final

```
#!/usr/bin/env Rscript
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)

print("Installing R libraries")
install.packages("chron")
install.packages("tidyverse")
install.packages("tinytex")

tinytex::install_tinytex()
```

# Overview
For fulfillment of DTSA-5301 finals *COVID19 dataset from the Johns Hopkins github site* part of the assignment.

# TODO explain data source
# TODO explain data
# TODO clean up data
# TODO create various ARDs
# TODO create plots (2)
# TODO model (1)
# TODO bias

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(chron)
```
# Data source
The main data source is the github repository at
https://github.com/CSSEGISandData/COVID-19

We will use the data from the folder at  
https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series

Two of the time series tables are for the US confirmed cases and deaths, reported at the county level.  
They are `time_series_covid19_confirmed_US.csv` and `time_series_covid19_deaths_US.csv` respectively.

We will focus on analyzing the data for United States only.

These two files will provide our data for the analysis.

```{r load_data, echo=TRUE, results=FALSE, message=FALSE}
covid19_confirmed_url = "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"
covid19_deaths_url = "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"

covid19_confirmed_raw <- read_csv(covid19_confirmed_url)
covid19_deaths_raw <- read_csv(covid19_deaths_url)
```


## Clean up data
We clean up the data mainly through the following three operations:  
- variables to factor for appropriate columns  
- date types from strings  
- remove unneeded columns  
- pivot

### Pivot long 

```{r pivot_data, echo=TRUE}
covid19_confirmed <- covid19_confirmed_raw %>%
  pivot_longer(cols = -c("UID", "iso2", "iso3", "code3", "FIPS", "Admin2",
                         "Province_State","Country_Region", "Lat", "Long_", "Combined_Key"),
                       names_to = "date",
                       values_to = "cases") %>%
  select(-c(Lat, Long_)) ## unwanted columns?

covid19_deaths <- covid19_deaths_raw %>%
  pivot_longer(cols = -c("UID", "iso2", "iso3", "code3", "FIPS", "Admin2",
                         "Province_State","Country_Region", "Lat", "Long_", "Combined_Key", "Population"),
                       names_to = "date",
                       values_to = "deaths") %>%
  select(-c(Lat, Long_)) ## unwanted columns?

```

### Join cases and deaths data and change column types (factor, date)


```{r join_factor_data, echo=TRUE}

covid19 <- covid19_confirmed %>%
  full_join(covid19_deaths) %>%
  mutate(iso3 = factor(iso3)) %>%
  mutate(Admin2 = factor(Admin2)) %>%
  mutate(Province_State = factor(Province_State)) %>%
  mutate(Country_Region = factor(Country_Region)) %>%
  mutate(date = mdy(date)) %>%
  # mutate(new_cases = cases - lag(cases)) %>%
  # mutate(new_deaths = deaths - lag(deaths)) %>%
  select (-c(UID, iso2, code3, FIPS))

# covid19 <- covid19 %>% filter(cases == 0)
```


## Missing data columns and plans to handle them
There is missing data in the following columns:
```{r missing_data, echo=TRUE}
names(which(colSums(is.na(covid19)) > 0))
# filter(covid19, is.na(Admin2))
```

I do not need cruise ships data for this report.
```{r cruise_ships_remove, echo=TRUE}
covid19 <- covid19 %>%
  filter(iso3 == "USA") %>%  # filter non states for simplicity
  filter(!is.na(Admin2))     # ignore cruise ships
```

### Summary of the cleaned up data

```{r summary, echo=TRUE}
summary(covid19)
```

### filter data
```{r filter_data, echo=TRUE}
covid19 <- covid19 %>%
  filter(cases > 0)
```

### Data issues
There are deaths with population zero. This is because the deaths are recorded with unassigned county (Alaska).



## Visualization and Analysis

### Generate necessary analysis ready data.  

Generate per state aggregated data.

```{r}
covid19_by_state <- covid19 %>%
  group_by(Province_State, Country_Region, date) %>%
  summarise(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>%
  mutate(deaths_per_million = deaths * 1000000 / Population) %>%
  select(Province_State, Country_Region, date, 
         cases, deaths, deaths_per_million, Population) %>%
  ungroup()
```

### Plot 
```{r}
covid19_by_state %>%
  ggplot(aes(x = date, y = cases)) +
  
  geom_line(aes(color = "cases")) +
  geom_point(aes(color = "cases")) +
  
  geom_line(aes(y = deaths, color = "deaths")) +
  geom_point(aes(y = deaths, color = "deaths")) +
  
  scale_y_log10() +
  
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) +
  
  labs(title = "COVID19 in US", y = NULL)
```

Plot for just one month
```{r}
covid19_by_state %>%
  filter (year(date) == 2020) %>%
  filter (month(date) == 3) %>%
  # filter (month(date) == 4 | month(date) == 5) %>%
  # filter (day(date) < 25) %>%
  ggplot(aes(x = date, y = cases)) +
  
  geom_point(aes(color = "cases")) +
  
  geom_point(aes(y = deaths, color = "deaths")) +
  
  scale_y_log10() +
  
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) +
  
  labs(title = "COVID19 in US", y = NULL)
```

